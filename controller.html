<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydrogen Simulation Controller</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4ecca3;
            font-size: 2rem;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            color: #4ecca3;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h3 {
            color: #888;
            margin: 15px 0 10px 0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card h2 .icon {
            font-size: 1.4rem;
        }

        /* Parameter inputs */
        .param-group {
            margin-bottom: 12px;
        }

        .param-group label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 0.85rem;
        }

        .param-group input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 0.95rem;
        }

        .param-group input:focus {
            outline: none;
            border-color: #4ecca3;
        }

        .param-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .param-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: #4ecca3;
            color: #1a1a2e;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #3db892;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn-blender {
            background: #ea7600;
            color: #fff;
        }

        .btn-blender:hover {
            background: #ff8c1a;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group .btn {
            flex: 1;
        }

        /* Network visualization */
        .network-canvas {
            width: 100%;
            height: 200px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .node {
            position: absolute;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            cursor: move;
            transition: transform 0.1s;
        }

        .node.producer {
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            background: #4ecca3;
            color: #1a1a2e;
        }

        .node.converter {
            background: #f0c040;
            color: #1a1a2e;
            border-radius: 4px;
        }

        .node.consumer {
            background: #e74c3c;
            color: #fff;
            border-radius: 50%;
        }

        .node:hover {
            transform: scale(1.1);
        }

        /* Results */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .results-grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .result-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 6px;
        }

        .result-item .label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 2px;
        }

        .result-item .value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4ecca3;
        }

        .result-item .value.negative {
            color: #e74c3c;
        }

        .result-item .value.positive {
            color: #4ecca3;
        }

        .result-item .unit {
            font-size: 0.75rem;
            color: #888;
        }

        /* Tranches table */
        .tranches-table {
            width: 100%;
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .tranches-table th, .tranches-table td {
            padding: 6px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tranches-table th {
            color: #888;
            font-weight: normal;
        }

        .tranches-table .utilization {
            width: 80px;
        }

        .utilization-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .utilization-fill {
            height: 100%;
            background: #4ecca3;
            transition: width 0.3s;
        }

        /* Status */
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .status.success {
            background: rgba(78, 204, 163, 0.2);
            border: 1px solid #4ecca3;
        }

        .status.error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid #e74c3c;
        }

        .status.info {
            background: rgba(52, 152, 219, 0.2);
            border: 1px solid #3498db;
        }

        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Card spanning full width */
        .card-wide {
            grid-column: 1 / -1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hydrogen Simulation Controller</h1>

        <div class="grid">
            <!-- Parameters Card -->
            <div class="card">
                <h2><span class="icon">âš¡</span> Production & Costs</h2>

                <div class="param-group">
                    <label>Simulation Periods (hours)</label>
                    <input type="number" id="periods" value="24" min="1" max="168">
                </div>

                <h3>Alpha - Electricity Producer</h3>
                <div class="param-row">
                    <div class="param-group">
                        <label>Capacity (kW)</label>
                        <input type="number" id="alpha_capacity" value="100" min="0" step="10">
                    </div>
                    <div class="param-group">
                        <label>Cost (ct/kWh)</label>
                        <input type="number" id="alpha_cost" value="8" min="0" step="0.5">
                    </div>
                </div>

                <h3>Bravo - Electrolyzer</h3>
                <div class="param-row-3">
                    <div class="param-group">
                        <label>Capacity (kW)</label>
                        <input type="number" id="bravo_capacity" value="50" min="0" step="10">
                    </div>
                    <div class="param-group">
                        <label>Efficiency (%)</label>
                        <input type="number" id="bravo_efficiency" value="70" min="0" max="100" step="5">
                    </div>
                    <div class="param-group">
                        <label>Cost (ct/kWh)</label>
                        <input type="number" id="bravo_cost" value="1.5" min="0" step="0.1">
                    </div>
                </div>

                <h3>Grid Backup</h3>
                <div class="param-group">
                    <label>Grid Electricity Cost (ct/kWh)</label>
                    <input type="number" id="grid_cost" value="15" min="0" step="1">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="runSimulation()">
                        <span id="sim-icon">â–¶</span> Run Simulation
                    </button>
                </div>

                <div id="sim-status"></div>
            </div>

            <!-- Consumer Utility Card -->
            <div class="card">
                <h2><span class="icon">ðŸ“ˆ</span> Consumer Utility Functions</h2>

                <h3>Charlie - Hydrogen (Logarithmic)</h3>
                <p style="color:#666;font-size:0.75rem;margin-bottom:8px;">U(x) = scale Ã— ln(1 + x/shape)</p>
                <div class="param-row-3">
                    <div class="param-group">
                        <label>Scale (a)</label>
                        <input type="number" id="charlie_scale" value="30" min="1" step="1">
                    </div>
                    <div class="param-group">
                        <label>Shape (b)</label>
                        <input type="number" id="charlie_shape" value="5" min="0.1" step="0.5">
                    </div>
                    <div class="param-group">
                        <label>Max Qty (kg/h)</label>
                        <input type="number" id="charlie_max_quantity" value="25" min="1" step="5">
                    </div>
                </div>

                <h3>Delta - Electricity (Logarithmic)</h3>
                <p style="color:#666;font-size:0.75rem;margin-bottom:8px;">U(x) = scale Ã— ln(1 + x/shape)</p>
                <div class="param-row-3">
                    <div class="param-group">
                        <label>Scale (a)</label>
                        <input type="number" id="delta_scale" value="25" min="1" step="1">
                    </div>
                    <div class="param-group">
                        <label>Shape (b)</label>
                        <input type="number" id="delta_shape" value="10" min="0.1" step="0.5">
                    </div>
                    <div class="param-group">
                        <label>Max Qty (kWh/h)</label>
                        <input type="number" id="delta_max_quantity" value="50" min="1" step="5">
                    </div>
                </div>

                <h3 style="display:flex;align-items:center;gap:10px;">
                    Echo - Both (Cobb-Douglas)
                    <label style="font-size:0.8rem;color:#888;font-weight:normal;">
                        <input type="checkbox" id="include_echo" checked style="margin-right:4px;">Enable
                    </label>
                </h3>
                <p style="color:#666;font-size:0.75rem;margin-bottom:8px;">U(h,e) = A Ã— h<sup>Î±</sup> Ã— e<sup>Î²</sup></p>
                <div class="param-row-3">
                    <div class="param-group">
                        <label>Scale (A)</label>
                        <input type="number" id="echo_A" value="15" min="0.1" step="1">
                    </div>
                    <div class="param-group">
                        <label>H2 exp (Î±)</label>
                        <input type="number" id="echo_alpha" value="0.4" min="0.01" max="1" step="0.05">
                    </div>
                    <div class="param-group">
                        <label>Elec exp (Î²)</label>
                        <input type="number" id="echo_beta" value="0.6" min="0.01" max="1" step="0.05">
                    </div>
                </div>
                <div class="param-row-3">
                    <div class="param-group">
                        <label>H2/bundle (kg)</label>
                        <input type="number" id="echo_h_per_bundle" value="1" min="0.1" step="0.5">
                    </div>
                    <div class="param-group">
                        <label>Elec/bundle (kWh)</label>
                        <input type="number" id="echo_e_per_bundle" value="3" min="0.1" step="0.5">
                    </div>
                    <div class="param-group">
                        <label>Max bundles/h</label>
                        <input type="number" id="echo_max_bundles" value="15" min="1" step="1">
                    </div>
                </div>
            </div>

            <!-- Economic Results Card -->
            <div class="card">
                <h2><span class="icon">ðŸ’°</span> Economic Results</h2>

                <div class="results-grid-3">
                    <div class="result-item">
                        <div class="label">Total Costs</div>
                        <div class="value negative" id="res-costs">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Total Utility</div>
                        <div class="value positive" id="res-utility">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Net Welfare</div>
                        <div class="value" id="res-welfare">--</div>
                    </div>
                </div>

                <h3>Production</h3>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="label">Alpha Production</div>
                        <div class="value" id="res-alpha">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Grid Supply</div>
                        <div class="value" id="res-grid">--</div>
                    </div>
                </div>

                <h3>Consumption by Consumer</h3>
                <div class="results-grid-3">
                    <div class="result-item">
                        <div class="label">Charlie (H2)</div>
                        <div class="value" id="res-charlie">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Delta (Elec)</div>
                        <div class="value" id="res-delta">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Echo (Bundles)</div>
                        <div class="value" id="res-echo-bundles">--</div>
                    </div>
                </div>

                <h3>Totals & Echo Breakdown</h3>
                <div class="results-grid">
                    <div class="result-item">
                        <div class="label">Total H2 Consumed</div>
                        <div class="value" id="res-total-h2">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Total Elec Consumed</div>
                        <div class="value" id="res-total-elec">--</div>
                    </div>
                </div>
                <div class="results-grid" id="echo-breakdown" style="margin-top:8px;">
                    <div class="result-item">
                        <div class="label">Echo H2</div>
                        <div class="value" id="res-echo-h2">--</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Echo Elec</div>
                        <div class="value" id="res-echo-elec">--</div>
                    </div>
                </div>

                <h3>Marginal Cost</h3>
                <div class="result-item">
                    <div class="label">Hydrogen Production Cost</div>
                    <div class="value" id="res-h2-cost">--</div>
                </div>

                <div id="results-status"></div>
            </div>

            <!-- Tranche Utilization Card -->
            <div class="card">
                <h2><span class="icon">ðŸ“Š</span> Utility Tranche Utilization</h2>

                <h3>Charlie (Hydrogen - Logarithmic)</h3>
                <table class="tranches-table" id="charlie-tranches-table">
                    <tr><th>Tranche</th><th>MU</th><th>Consumed</th><th class="utilization">Usage</th></tr>
                    <tr><td colspan="4" style="color:#666">Run simulation...</td></tr>
                </table>

                <h3>Delta (Electricity - Logarithmic)</h3>
                <table class="tranches-table" id="delta-tranches-table">
                    <tr><th>Tranche</th><th>MU</th><th>Consumed</th><th class="utilization">Usage</th></tr>
                    <tr><td colspan="4" style="color:#666">Run simulation...</td></tr>
                </table>

                <h3 id="echo-tranches-header">Echo (Bundles - Cobb-Douglas)</h3>
                <table class="tranches-table" id="echo-tranches-table">
                    <tr><th>Tranche</th><th>MU</th><th>Consumed</th><th class="utilization">Usage</th></tr>
                    <tr><td colspan="4" style="color:#666">Run simulation...</td></tr>
                </table>
            </div>

            <!-- Time Series Charts Card -->
            <div class="card card-wide">
                <h2><span class="icon">ðŸ“ˆ</span> Time Series Analysis</h2>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div id="chart-electricity" style="width:100%;height:280px;"></div>
                    </div>
                    <div>
                        <div id="chart-hydrogen" style="width:100%;height:280px;"></div>
                    </div>
                </div>

                <div style="margin-top: 15px;">
                    <div id="chart-stacked" style="width:100%;height:300px;"></div>
                </div>
            </div>

            <!-- Network Card -->
            <div class="card">
                <h2><span class="icon">ðŸ”—</span> Network Topology</h2>

                <div class="network-canvas" id="network-canvas">
                    <svg id="pipes-svg" style="position:absolute;width:100%;height:100%;pointer-events:none;"></svg>
                </div>

                <div id="network-status"></div>
            </div>

            <!-- Blender Card -->
            <div class="card">
                <h2><span class="icon">ðŸŽ¨</span> Blender Integration</h2>

                <p style="color: #888; margin-bottom: 15px; font-size: 0.85rem;">
                    Sync node positions between this controller and Blender.
                </p>

                <div class="btn-group">
                    <button class="btn btn-blender" onclick="launchBlender()">
                        ðŸš€ Launch Blender
                    </button>
                </div>

                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="exportToBlender()">
                        ðŸ“¤ Export
                    </button>
                    <button class="btn btn-secondary" onclick="syncFromBlender()">
                        ðŸ“¥ Sync
                    </button>
                </div>

                <div id="blender-status"></div>

                <div style="margin-top: 15px; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 0.8rem; color: #888;">
                    <strong>In Blender:</strong> <code style="color: #4ecca3;">sync_from_blender()</code>
                </div>
            </div>
        </div>

        <div class="footer">
            Hydrogen System Simulation | Logarithmic & Cobb-Douglas Utility Functions
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Node positions (normalized 0-1)
        let nodes = {
            'Alpha': { x: 0.5, y: 0.1, type: 'producer' },
            'Bravo': { x: 0.2, y: 0.5, type: 'converter' },
            'Charlie': { x: 0.2, y: 0.85, type: 'consumer' },
            'Delta': { x: 0.8, y: 0.5, type: 'consumer' },
            'Echo': { x: 0.5, y: 0.85, type: 'consumer' }
        };

        const edges = [
            { source: 'Alpha', target: 'Bravo', carrier: 'electricity' },
            { source: 'Alpha', target: 'Delta', carrier: 'electricity' },
            { source: 'Alpha', target: 'Echo', carrier: 'electricity' },
            { source: 'Bravo', target: 'Charlie', carrier: 'hydrogen' },
            { source: 'Bravo', target: 'Echo', carrier: 'hydrogen' }
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadConfig();
            loadNetwork();
            renderNetwork();
        });

        // Load configuration
        async function loadConfig() {
            try {
                const res = await fetch(`${API_BASE}/api/config`);
                const config = await res.json();

                // Basic parameters
                document.getElementById('periods').value = config.periods;
                document.getElementById('alpha_capacity').value = config.alpha_capacity;
                document.getElementById('alpha_cost').value = config.alpha_cost;
                document.getElementById('bravo_capacity').value = config.bravo_capacity;
                document.getElementById('bravo_efficiency').value = config.bravo_efficiency * 100;
                document.getElementById('bravo_cost').value = config.bravo_cost;
                document.getElementById('grid_cost').value = config.grid_cost;

                // Charlie utility (logarithmic)
                document.getElementById('charlie_scale').value = config.charlie_scale || 30;
                document.getElementById('charlie_shape').value = config.charlie_shape || 5;
                document.getElementById('charlie_max_quantity').value = config.charlie_max_quantity || 25;

                // Delta utility (logarithmic)
                document.getElementById('delta_scale').value = config.delta_scale || 25;
                document.getElementById('delta_shape').value = config.delta_shape || 10;
                document.getElementById('delta_max_quantity').value = config.delta_max_quantity || 50;

                // Echo utility (Cobb-Douglas)
                document.getElementById('include_echo').checked = config.include_echo !== false;
                document.getElementById('echo_A').value = config.echo_A || 15;
                document.getElementById('echo_alpha').value = config.echo_alpha || 0.4;
                document.getElementById('echo_beta').value = config.echo_beta || 0.6;
                document.getElementById('echo_h_per_bundle').value = config.echo_h_per_bundle || 1;
                document.getElementById('echo_e_per_bundle').value = config.echo_e_per_bundle || 3;
                document.getElementById('echo_max_bundles').value = config.echo_max_bundles || 15;
            } catch (e) {
                console.error('Failed to load config:', e);
            }
        }

        // Load network
        async function loadNetwork() {
            try {
                const res = await fetch(`${API_BASE}/api/network`);
                const network = await res.json();

                if (network.nodes) {
                    network.nodes.forEach(node => {
                        if (nodes[node.name]) {
                            nodes[node.name].x = (node.position[0] + 3) / 6;
                            nodes[node.name].y = 1 - (node.position[1] + 3) / 6;
                        }
                    });
                    renderNetwork();
                }
            } catch (e) {
                console.error('Failed to load network:', e);
            }
        }

        // Render network visualization
        function renderNetwork() {
            const canvas = document.getElementById('network-canvas');
            const svg = document.getElementById('pipes-svg');
            const rect = canvas.getBoundingClientRect();

            canvas.querySelectorAll('.node').forEach(n => n.remove());
            svg.innerHTML = '';

            // Draw pipes
            edges.forEach(edge => {
                const source = nodes[edge.source];
                const target = nodes[edge.target];

                const x1 = source.x * rect.width;
                const y1 = source.y * rect.height;
                const x2 = target.x * rect.width;
                const y2 = target.y * rect.height;

                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', x1);
                line.setAttribute('y1', y1);
                line.setAttribute('x2', x2);
                line.setAttribute('y2', y2);
                line.setAttribute('stroke', edge.carrier === 'electricity' ? '#f0c040' : '#3498db');
                line.setAttribute('stroke-width', '4');
                line.setAttribute('stroke-linecap', 'round');
                svg.appendChild(line);
            });

            // Draw nodes
            Object.entries(nodes).forEach(([name, node]) => {
                const el = document.createElement('div');
                el.className = `node ${node.type}`;
                el.textContent = name;
                el.style.left = `${node.x * rect.width - 25}px`;
                el.style.top = `${node.y * rect.height - 25}px`;
                el.addEventListener('mousedown', startDrag);
                el.dataset.name = name;
                canvas.appendChild(el);
            });
        }

        // Drag functionality
        let dragging = null;
        let dragOffset = { x: 0, y: 0 };

        function startDrag(e) {
            dragging = e.target;
            const rect = dragging.getBoundingClientRect();
            dragOffset.x = e.clientX - rect.left - 25;
            dragOffset.y = e.clientY - rect.top - 25;
            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        }

        function doDrag(e) {
            if (!dragging) return;
            const canvas = document.getElementById('network-canvas');
            const rect = canvas.getBoundingClientRect();
            let x = (e.clientX - rect.left - dragOffset.x) / rect.width;
            let y = (e.clientY - rect.top - dragOffset.y) / rect.height;
            x = Math.max(0.1, Math.min(0.9, x));
            y = Math.max(0.1, Math.min(0.9, y));
            const name = dragging.dataset.name;
            nodes[name].x = x;
            nodes[name].y = y;
            renderNetwork();
        }

        function stopDrag() {
            if (dragging) updateNetworkPositions();
            dragging = null;
            document.removeEventListener('mousemove', doDrag);
            document.removeEventListener('mouseup', stopDrag);
        }

        async function updateNetworkPositions() {
            const networkNodes = Object.entries(nodes).map(([name, node]) => ({
                name,
                node_type: node.type,
                carrier: node.type === 'producer' ? 'electricity' : node.type === 'converter' ? 'both' : 'hydrogen',
                position: [(node.x * 6) - 3, ((1 - node.y) * 6) - 3, 0]
            }));

            try {
                await fetch(`${API_BASE}/api/network`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nodes: networkNodes })
                });
            } catch (e) {
                console.error('Failed to update network:', e);
            }
        }

        // Run simulation
        async function runSimulation() {
            const btn = document.querySelector('[onclick="runSimulation()"]');
            const icon = document.getElementById('sim-icon');
            const status = document.getElementById('sim-status');

            btn.disabled = true;
            icon.innerHTML = '<div class="spinner"></div>';

            // Build config with utility function parameters
            const config = {
                periods: parseInt(document.getElementById('periods').value),
                alpha_capacity: parseFloat(document.getElementById('alpha_capacity').value),
                alpha_cost: parseFloat(document.getElementById('alpha_cost').value),
                bravo_capacity: parseFloat(document.getElementById('bravo_capacity').value),
                bravo_efficiency: parseFloat(document.getElementById('bravo_efficiency').value) / 100,
                bravo_cost: parseFloat(document.getElementById('bravo_cost').value),
                grid_cost: parseFloat(document.getElementById('grid_cost').value),

                // Charlie utility (logarithmic)
                charlie_scale: parseFloat(document.getElementById('charlie_scale').value),
                charlie_shape: parseFloat(document.getElementById('charlie_shape').value),
                charlie_max_quantity: parseFloat(document.getElementById('charlie_max_quantity').value),

                // Delta utility (logarithmic)
                delta_scale: parseFloat(document.getElementById('delta_scale').value),
                delta_shape: parseFloat(document.getElementById('delta_shape').value),
                delta_max_quantity: parseFloat(document.getElementById('delta_max_quantity').value),

                // Echo utility (Cobb-Douglas)
                include_echo: document.getElementById('include_echo').checked,
                echo_A: parseFloat(document.getElementById('echo_A').value),
                echo_alpha: parseFloat(document.getElementById('echo_alpha').value),
                echo_beta: parseFloat(document.getElementById('echo_beta').value),
                echo_h_per_bundle: parseFloat(document.getElementById('echo_h_per_bundle').value),
                echo_e_per_bundle: parseFloat(document.getElementById('echo_e_per_bundle').value),
                echo_max_bundles: parseFloat(document.getElementById('echo_max_bundles').value),
            };

            try {
                await fetch(`${API_BASE}/api/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                const res = await fetch(`${API_BASE}/api/simulate`, { method: 'POST' });
                const data = await res.json();

                if (data.status === 'ok') {
                    status.className = 'status success';
                    status.textContent = 'Simulation completed!';
                    updateResults(data);
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                status.className = 'status error';
                status.textContent = 'Error: ' + e.message;
            }

            btn.disabled = false;
            icon.textContent = 'â–¶';
        }

        function updateResults(data) {
            const s = data.summary;
            const includeEcho = data.config && data.config.include_echo !== false;

            // Update time series charts
            if (data.flows) {
                updateCharts(data);
            }

            // Economic results
            document.getElementById('res-costs').textContent = (s.total_costs || 0).toFixed(0) + ' ct';
            document.getElementById('res-utility').textContent = (s.total_utility || 0).toFixed(0) + ' ct';
            document.getElementById('res-welfare').textContent = (s.total_welfare || 0).toFixed(0) + ' ct';
            document.getElementById('res-welfare').className = 'value ' + (s.total_welfare >= 0 ? 'positive' : 'negative');

            // Production
            document.getElementById('res-alpha').textContent = (s.total_alpha_production || 0).toFixed(1) + ' kWh';
            document.getElementById('res-grid').textContent = (s.total_grid_supply || 0).toFixed(1) + ' kWh';

            // Consumption by consumer
            document.getElementById('res-charlie').textContent = (s.charlie_hydrogen_consumed || 0).toFixed(1) + ' kg';
            document.getElementById('res-delta').textContent = (s.delta_electricity_consumed || 0).toFixed(1) + ' kWh';
            document.getElementById('res-echo-bundles').textContent = includeEcho ?
                (s.echo_bundles_consumed || 0).toFixed(1) : 'N/A';

            // Totals and Echo breakdown
            document.getElementById('res-total-h2').textContent = (s.total_hydrogen_consumed || 0).toFixed(1) + ' kg';
            document.getElementById('res-total-elec').textContent = (s.total_electricity_consumed || 0).toFixed(1) + ' kWh';

            // Echo breakdown
            const echoBreakdown = document.getElementById('echo-breakdown');
            if (includeEcho) {
                echoBreakdown.style.display = 'grid';
                document.getElementById('res-echo-h2').textContent = (s.echo_hydrogen_consumed || 0).toFixed(1) + ' kg';
                document.getElementById('res-echo-elec').textContent = (s.echo_electricity_consumed || 0).toFixed(1) + ' kWh';
            } else {
                echoBreakdown.style.display = 'none';
            }

            // H2 marginal cost
            if (data.price_analysis && data.price_analysis.hydrogen) {
                document.getElementById('res-h2-cost').textContent =
                    data.price_analysis.hydrogen.marginal_cost.toFixed(2) + ' ct/kWh';
            }

            // Tranche utilization tables
            if (data.price_analysis) {
                updateTrancheTable('charlie-tranches-table', data.price_analysis.hydrogen.consumer_tranches, 'kg');
                updateTrancheTable('delta-tranches-table', data.price_analysis.electricity.consumer_tranches, 'kWh');

                // Echo tranches
                const echoHeader = document.getElementById('echo-tranches-header');
                const echoTable = document.getElementById('echo-tranches-table');
                if (includeEcho && data.price_analysis.echo && data.price_analysis.echo.bundles) {
                    echoHeader.style.display = 'flex';
                    echoTable.style.display = 'table';
                    updateTrancheTable('echo-tranches-table', data.price_analysis.echo.bundles, 'bundles');
                } else {
                    echoHeader.style.display = 'none';
                    echoTable.style.display = 'none';
                }
            }
        }

        function updateTrancheTable(tableId, tranches, unit) {
            const table = document.getElementById(tableId);
            table.innerHTML = '<tr><th>Tranche</th><th>MU</th><th>Consumed</th><th class="utilization">Usage</th></tr>';

            if (!tranches || tranches.length === 0) {
                table.innerHTML += '<tr><td colspan="4" style="color:#666">No data</td></tr>';
                return;
            }

            tranches.forEach(t => {
                const row = document.createElement('tr');
                // Handle both willingness_to_pay and wtp field names
                const wtp = t.willingness_to_pay || t.wtp || 0;
                const consumed = t.consumed || 0;
                const utilization = t.utilization || 0;
                row.innerHTML = `
                    <td>T${t.tranche}</td>
                    <td>${wtp.toFixed(1)} ct</td>
                    <td>${consumed.toFixed(1)} ${unit}</td>
                    <td class="utilization">
                        <div class="utilization-bar">
                            <div class="utilization-fill" style="width:${Math.min(100, utilization)}%"></div>
                        </div>
                    </td>
                `;
                table.appendChild(row);
            });
        }

        // Blender functions
        async function launchBlender() {
            const status = document.getElementById('blender-status');
            try {
                const res = await fetch(`${API_BASE}/api/blender/launch`, { method: 'POST' });
                const data = await res.json();
                status.className = 'status ' + (data.status === 'ok' ? 'success' : 'info');
                status.textContent = data.message;
            } catch (e) {
                status.className = 'status error';
                status.textContent = 'Error: ' + e.message;
            }
        }

        async function exportToBlender() {
            const status = document.getElementById('blender-status');
            try {
                const res = await fetch(`${API_BASE}/api/blender/export`, { method: 'POST' });
                const data = await res.json();
                status.className = 'status ' + (data.status === 'ok' ? 'success' : 'error');
                status.textContent = data.message;
            } catch (e) {
                status.className = 'status error';
                status.textContent = 'Error: ' + e.message;
            }
        }

        async function syncFromBlender() {
            const status = document.getElementById('blender-status');
            try {
                const res = await fetch(`${API_BASE}/api/blender/sync`, { method: 'POST' });
                const data = await res.json();
                if (data.status === 'ok') {
                    status.className = 'status success';
                    status.textContent = 'Synced from Blender!';
                    loadNetwork();
                } else {
                    throw new Error(data.message);
                }
            } catch (e) {
                status.className = 'status error';
                status.textContent = 'Error: ' + e.message;
            }
        }

        window.addEventListener('resize', renderNetwork);

        // =========================================
        // Time Series Charts with Plotly
        // =========================================

        const chartColors = {
            alpha: '#4ecca3',      // Green - Alpha production
            grid: '#e74c3c',       // Red - Grid supply
            bravo: '#f0c040',      // Yellow - Electrolyzer
            delta: '#3498db',      // Blue - Delta consumption
            charlie: '#9b59b6',    // Purple - Charlie consumption
            hydrogen: '#1abc9c',   // Teal - Hydrogen
            echo: '#e67e22'        // Orange - Echo consumption
        };

        const chartLayout = {
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0.2)',
            font: { color: '#eee', size: 11 },
            margin: { t: 40, r: 20, b: 50, l: 60 },
            legend: { orientation: 'h', y: -0.15 },
            xaxis: {
                title: 'Hour',
                gridcolor: 'rgba(255,255,255,0.1)',
                zerolinecolor: 'rgba(255,255,255,0.2)'
            },
            yaxis: {
                gridcolor: 'rgba(255,255,255,0.1)',
                zerolinecolor: 'rgba(255,255,255,0.2)'
            }
        };

        function initCharts() {
            // Electricity chart placeholder
            Plotly.newPlot('chart-electricity', [], {
                ...chartLayout,
                title: { text: 'Electricity Flows', font: { size: 14, color: '#4ecca3' } },
                yaxis: { ...chartLayout.yaxis, title: 'Power (kW)' }
            }, { responsive: true });

            // Hydrogen chart placeholder
            Plotly.newPlot('chart-hydrogen', [], {
                ...chartLayout,
                title: { text: 'Hydrogen Flows', font: { size: 14, color: '#1abc9c' } },
                yaxis: { ...chartLayout.yaxis, title: 'Flow (kg/h)' }
            }, { responsive: true });

            // Stacked area chart placeholder
            Plotly.newPlot('chart-stacked', [], {
                ...chartLayout,
                title: { text: 'Energy Balance Over Time', font: { size: 14, color: '#4ecca3' } },
                yaxis: { ...chartLayout.yaxis, title: 'Energy (kWh)' }
            }, { responsive: true });
        }

        function updateCharts(data) {
            const flows = data.flows;
            const periods = data.config.periods;
            const hours = Array.from({ length: periods }, (_, i) => i);

            // Extract flow data (handle various formats and naming conventions)
            const getFlowData = (flowNames) => {
                // Accept array of possible names
                const names = Array.isArray(flowNames) ? flowNames : [flowNames];
                for (const name of names) {
                    // Try exact match first
                    if (flows[name]) {
                        const flow = flows[name];
                        if (flow.length === 0) continue;
                        // If nested array [[val], [val], ...], extract values
                        if (Array.isArray(flow[0])) {
                            return flow.map(v => v[0] || 0);
                        }
                        return flow;
                    }
                    // Try case-insensitive match
                    const key = Object.keys(flows).find(k => k.toLowerCase() === name.toLowerCase());
                    if (key) {
                        const flow = flows[key];
                        if (flow.length === 0) continue;
                        if (Array.isArray(flow[0])) {
                            return flow.map(v => v[0] || 0);
                        }
                        return flow;
                    }
                }
                return new Array(periods).fill(0);
            };

            // Get all flow data (try multiple possible names)
            const alphaProduction = getFlowData(['Alpha_production', 'alpha_production']);
            const gridSupply = getFlowData(['Grid_supply', 'grid_supply']);
            const bravoConversion = getFlowData(['Bravo_conversion', 'bravo_conversion']);
            const deltaConsumption = getFlowData(['Delta_consumption', 'delta_consumption']);
            const charlieConsumption = getFlowData(['Charlie_consumption', 'charlie_consumption']);
            const echoConsumption = getFlowData(['Echo_consumption', 'echo_consumption']);
            const echoHydrogen = getFlowData(['Echo_hydrogen', 'echo_hydrogen']);
            const echoElectricity = getFlowData(['Echo_electricity', 'echo_electricity']);

            // Estimate electrolyzer input/output from conversion data
            const bravoInput = bravoConversion.map(v => v / (data.config.bravo_efficiency || 0.7));
            const bravoOutput = bravoConversion;

            // Include Echo?
            const includeEcho = data.config && data.config.include_echo !== false;

            // Electricity chart - production vs consumption
            const electricityTraces = [
                {
                    x: hours,
                    y: alphaProduction,
                    name: 'Alpha Production',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.alpha, width: 2 },
                    marker: { size: 4 }
                },
                {
                    x: hours,
                    y: gridSupply,
                    name: 'Grid Supply',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.grid, width: 2, dash: 'dash' },
                    marker: { size: 4 }
                },
                {
                    x: hours,
                    y: bravoInput,
                    name: 'To Electrolyzer',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.bravo, width: 2 },
                    marker: { size: 4 }
                },
                {
                    x: hours,
                    y: deltaConsumption,
                    name: 'Delta Consumption',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.delta, width: 2 },
                    marker: { size: 4 }
                }
            ];

            // Add Echo electricity if enabled
            if (includeEcho) {
                electricityTraces.push({
                    x: hours,
                    y: echoElectricity,
                    name: 'Echo (Elec)',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.echo, width: 2, dash: 'dot' },
                    marker: { size: 4 }
                });
            }

            Plotly.react('chart-electricity', electricityTraces, {
                ...chartLayout,
                title: { text: 'Electricity Flows', font: { size: 14, color: '#4ecca3' } },
                yaxis: { ...chartLayout.yaxis, title: 'Power (kW)' }
            });

            // Hydrogen chart
            const hydrogenTraces = [
                {
                    x: hours,
                    y: bravoOutput,
                    name: 'Bravo Production',
                    type: 'scatter',
                    mode: 'lines+markers',
                    fill: 'tozeroy',
                    line: { color: chartColors.hydrogen, width: 2 },
                    fillcolor: 'rgba(26, 188, 156, 0.3)'
                },
                {
                    x: hours,
                    y: charlieConsumption,
                    name: 'Charlie Consumption',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.charlie, width: 2 },
                    marker: { size: 5 }
                }
            ];

            // Add Echo hydrogen if enabled
            if (includeEcho) {
                hydrogenTraces.push({
                    x: hours,
                    y: echoHydrogen,
                    name: 'Echo (H2)',
                    type: 'scatter',
                    mode: 'lines+markers',
                    line: { color: chartColors.echo, width: 2, dash: 'dot' },
                    marker: { size: 5 }
                });
            }

            Plotly.react('chart-hydrogen', hydrogenTraces, {
                ...chartLayout,
                title: { text: 'Hydrogen Flows', font: { size: 14, color: '#1abc9c' } },
                yaxis: { ...chartLayout.yaxis, title: 'Flow (kg/h)' }
            });

            // Stacked area chart - energy balance
            const stackedTraces = [
                {
                    x: hours,
                    y: alphaProduction,
                    name: 'Alpha (Local)',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    line: { color: chartColors.alpha, width: 0 },
                    fillcolor: 'rgba(78, 204, 163, 0.7)',
                    stackgroup: 'supply'
                },
                {
                    x: hours,
                    y: gridSupply,
                    name: 'Grid Import',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    line: { color: chartColors.grid, width: 0 },
                    fillcolor: 'rgba(231, 76, 60, 0.7)',
                    stackgroup: 'supply'
                },
                {
                    x: hours,
                    y: deltaConsumption.map(v => -v),
                    name: 'Delta (Direct)',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    line: { color: chartColors.delta, width: 0 },
                    fillcolor: 'rgba(52, 152, 219, 0.7)',
                    stackgroup: 'demand'
                },
                {
                    x: hours,
                    y: bravoInput.map(v => -v),
                    name: 'Electrolyzer',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    line: { color: chartColors.bravo, width: 0 },
                    fillcolor: 'rgba(240, 192, 64, 0.7)',
                    stackgroup: 'demand'
                }
            ];

            // Add Echo electricity demand if enabled
            if (includeEcho) {
                stackedTraces.push({
                    x: hours,
                    y: echoElectricity.map(v => -v),
                    name: 'Echo (Elec)',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tonexty',
                    line: { color: chartColors.echo, width: 0 },
                    fillcolor: 'rgba(230, 126, 34, 0.7)',
                    stackgroup: 'demand'
                });
            }

            Plotly.react('chart-stacked', stackedTraces, {
                ...chartLayout,
                title: { text: 'Energy Balance: Supply (+) vs Demand (-)', font: { size: 14, color: '#4ecca3' } },
                yaxis: { ...chartLayout.yaxis, title: 'Power (kW)', zeroline: true, zerolinewidth: 2 },
                barmode: 'relative'
            });
        }

        // Initialize charts on page load
        document.addEventListener('DOMContentLoaded', initCharts);
    </script>
</body>
</html>
